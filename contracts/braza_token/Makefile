# =====================================================================
# üöÄ BRAZA TOKEN - MAKEFILE OFICIAL (AUDIT EDITION üõ°Ô∏è)
# =====================================================================

# Cores ANSI
GREEN  := \033[32m
YELLOW := \033[33m
BLUE   := \033[34m
CYAN   := \033[36m
MAG    := \033[35m
RED    := \033[31m
RESET  := \033[0m

CONTRACT_NAME := braza_token
TARGET := wasm32-unknown-unknown
WASM_DIR := target/$(TARGET)/release
WASM_FILE := $(WASM_DIR)/$(CONTRACT_NAME).wasm
OPTIMIZED_WASM := $(WASM_DIR)/$(CONTRACT_NAME).optimized.wasm

# üåê Rede
NETWORK := testnet

# üìÇ Scripts
SCRIPTS := ./scripts

# =====================================================================
# üî® BUILD & OPTIMIZE
# =====================================================================

.PHONY: build
build:
	@echo "$(BLUE)üî® Compilando contrato (Release)...$(RESET)"
	cargo build --release --target $(TARGET)
	@echo "$(GREEN)‚úî Build conclu√≠do: $(WASM_FILE)$(RESET)"

.PHONY: optimize
optimize:
	@echo "$(MAG)‚ú® Otimizando WASM (Soroban Native)...$(RESET)"
	soroban contract optimize --wasm $(WASM_FILE)
	@echo "$(GREEN)‚úî Otimiza√ß√£o conclu√≠da: $(OPTIMIZED_WASM)$(RESET)"
	@ls -lh $(OPTIMIZED_WASM)

.PHONY: all
all: build optimize
	@echo "$(CYAN)üèÅ Build + Otimiza√ß√£o completos! Pronto para Deploy.$(RESET)"

# =====================================================================
# üß™ TESTES (AUDITORIA)
# =====================================================================

.PHONY: test
test:
	@echo "$(MAG)üß™ Rodando Testes Unit√°rios e de Integra√ß√£o...$(RESET)"
	cargo test
	@echo "$(GREEN)‚úî Todos os testes passaram!$(RESET)"

.PHONY: test-fuzz
test-fuzz:
	@echo "$(RED)üî• Rodando Testes de Estresse (Fuzzing)...$(RESET)"
	cargo test --test fuzz_proptest
	@echo "$(GREEN)‚úî O contrato sobreviveu ao caos!$(RESET)"

.PHONY: audit
audit: test test-fuzz
	@echo "$(CYAN)üõ°Ô∏è  AUDITORIA COMPLETA: APROVADA$(RESET)"

# =====================================================================
# üöÄ DEPLOY
# =====================================================================

.PHONY: deploy
deploy: all
	@echo "$(CYAN)üì¶ Iniciando deploy na $(NETWORK)...$(RESET)"
	$(SCRIPTS)/deploy.sh

.PHONY: initialize
initialize:
	@echo "$(CYAN)üß≠ Inicializando contrato...$(RESET)"
	$(SCRIPTS)/initialize.sh

.PHONY: verify
verify:
	@echo "$(CYAN)üîç Verificando contrato...$(RESET)"
	$(SCRIPTS)/verify.sh

# =====================================================================
# üé® FORMAT / LINT
# =====================================================================

.PHONY: fmt
fmt:
	@echo "$(YELLOW)üé® Formatando c√≥digo...$(RESET)"
	cargo fmt
	@echo "$(GREEN)‚úî C√≥digo formatado$(RESET)"

.PHONY: lint
lint:
	@echo "$(YELLOW)üßπ Rodando Clippy...$(RESET)"
	cargo clippy --all-targets --all-features -- -D warnings
	@echo "$(GREEN)‚úî Lint conclu√≠do sem warnings$(RESET)"

# =====================================================================
# üõ†Ô∏è UTILIDADES
# =====================================================================

.PHONY: clean
clean:
	@echo "$(YELLOW)üóë Limpando diret√≥rio target...$(RESET)"
	cargo clean
	@echo "$(GREEN)‚úî Limpeza conclu√≠da$(RESET)"

.PHONY: info
info:
	@echo "$(CYAN)üìå Informa√ß√µes do Projeto:$(RESET)"
	@echo "   ‚Ä¢ Contrato: $(CONTRACT_NAME)"
	@echo "   ‚Ä¢ Rede: $(NETWORK)"
	@echo "   ‚Ä¢ WASM Original: $(WASM_FILE)"
	@echo "   ‚Ä¢ WASM Otimizado: $(OPTIMIZED_WASM)"

# =====================================================================
# ‚ùì AJUDA
# =====================================================================

.PHONY: help
help:
	@echo ""
	@echo "$(GREEN)üìò BRAZA TOKEN - Comandos Dispon√≠veis$(RESET)"
	@echo ""
	@echo "$(BLUE)üî® make build$(RESET)      ‚Üí Compila o contrato"
	@echo "$(BLUE)‚öô make optimize$(RESET)   ‚Üí Otimiza o WASM (Gera .optimized.wasm)"
	@echo "$(BLUE)üöÄ make all$(RESET)        ‚Üí Build + Otimiza√ß√£o (Recomendado)"
	@echo ""
	@echo "$(MAG)üß™ make test$(RESET)       ‚Üí Roda testes padr√£o (Unit√°rios/Integra√ß√£o)"
	@echo "$(RED)üî• make test-fuzz$(RESET)  ‚Üí Roda testes de estresse (Proptest)"
	@echo "$(CYAN)üõ°Ô∏è  make audit$(RESET)      ‚Üí Roda TUDO (Testes + Fuzzing)"
	@echo ""
	@echo "$(CYAN)üì¶ make deploy$(RESET)     ‚Üí Deploy do contrato otimizado"
	@echo ""
	@echo "$(YELLOW)üé® make fmt$(RESET)       ‚Üí Formatador Rust"
	@echo "$(YELLOW)üßπ make lint$(RESET)      ‚Üí Clippy (Check de qualidade)"
	@echo "$(YELLOW)üóë make clean$(RESET)     ‚Üí Limpar target/"
	@echo ""
